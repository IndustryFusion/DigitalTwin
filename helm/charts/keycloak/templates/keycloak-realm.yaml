{{- $alertasecret := (lookup "v1" "Secret" .Release.Namespace "keycloak-client-secret-alerta-ui") -}}
{{- $oispfrontendsecret := (lookup "v1" "Secret" .Release.Namespace "keycloak-client-secret-oisp-frontend") -}}
{{- $mqttbrokersecret := (lookup "v1" "Secret" .Release.Namespace "keycloak-client-secret-mqtt-broker") -}}
{{- $fusionbackendsecret := (lookup "v1" "Secret" .Release.Namespace "keycloak-client-secret-fusion-backend") -}}
{{- $ngsildupdatessecret := (lookup "v1" "Secret" .Release.Namespace "keycloak-client-secret-ngsild-updates") -}}
{{- $realmusersecret := (lookup "v1" "Secret" .Release.Namespace "credential-iff-realm-user-iff") -}}
apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: iff-keycloak-realm-import
  labels:
    app: sso
spec:
  keycloakCRName: keycloak
  realm:
    id: {{ .Values.keycloak.alerta.realm | quote }}
    realm: {{ .Values.keycloak.alerta.realm | quote }}
    enabled: true
    revokeRefreshToken: false
    refreshTokenMaxReuse: 0
    accessTokenLifespan: 300
    accessTokenLifespanForImplicitFlow: 900
    ssoSessionIdleTimeout: 315360000
    ssoSessionMaxLifespan: 315360000
    ssoSessionIdleTimeoutRememberMe: 0
    ssoSessionMaxLifespanRememberMe: 0
    offlineSessionIdleTimeout: 2592000
    offlineSessionMaxLifespanEnabled: false
    offlineSessionMaxLifespan: 5184000
    clientSessionIdleTimeout: 0
    clientSessionMaxLifespan: 0
    clientOfflineSessionIdleTimeout: 0
    clientOfflineSessionMaxLifespan: 0
    accessCodeLifespan: 60
    accessCodeLifespanUserAction: 300
    accessCodeLifespanLogin: 1800
    actionTokenGeneratedByAdminLifespan: 43200
    actionTokenGeneratedByUserLifespan: 300
    sslRequired: external
    loginTheme: fusion
    accountTheme: fusion
    eventsListeners:
      - jboss-logging
      - oisp-event-listener
    displayName: "Basic Realm for Alerta and Scorpio"
    clientScopes:
      - id: a3e864e7-8641-46a2-a52f-0cb23d8bb936
        name: gateway
        protocol: openid-connect
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "false"
        protocolMappers:
          - id: 0adfc4f7-ceef-43d4-8ded-7bca05f61671
            name: gateway mapper
            protocol: openid-connect
            protocolMapper: script-gateway-mapper.js
            consentRequired: false
            config:
              id.token.claim: 'true'
              access.token.claim: 'true'
              claim.name: gateway
              jsonType.label: String
              userinfo.token.claim: 'true'
      - id: 829f8f77-0d01-4dc1-ab9e-5a9816a39ff8
        name: type
        protocol: openid-connect
        attributes:
          include.in.token.scope: 'true'
          display.on.consent.screen: 'false'
        protocolMappers:
          - id: 0fcbb880-7b3e-4878-ba29-710db602cd71
            name: type mapper
            protocol: openid-connect
            protocolMapper: script-type-mapper.js
            consentRequired: false
            config:
              id.token.claim: 'true'
              access.token.claim: 'true'
              claim.name: type
              jsonType.label: String
              userinfo.token.claim: 'true'
      - id: aff3473b-2ffd-4e3c-8696-4e3f5aa9cdde
        name: oisp-frontend
        protocol: openid-connect
        attributes:
          include.in.token.scope: 'true'
          display.on.consent.screen: 'true'
        protocolMappers:
          - id: 7b66be24-fe26-4be9-9116-0eccc31c4f34
            name: oisp-frontend
            protocol: openid-connect
            protocolMapper: oidc-audience-mapper
            consentRequired: false
            config:
              included.client.audience: {{ .Values.keycloak.oisp.frontend.client }}
              id.token.claim: 'false'
              access.token.claim: 'true'
              userinfo.token.claim: 'false'
      - id: 5ed16465-f532-4fd1-a697-b9f66d6160ac
        name: mqtt-broker
        protocol: openid-connect
        attributes:
          include.in.token.scope: 'true'
          display.on.consent.screen: 'false'
        protocolMappers:
          - id: 1ba18a0a-d3bf-4cf3-847a-d7416c4afe09
            name: mqtt-broker
            protocol: openid-connect
            protocolMapper: oidc-audience-mapper
            consentRequired: false
            config:
              included.client.audience: {{ .Values.keycloak.oisp.mqttBroker.client }}
              id.token.claim: 'false'
              access.token.claim: 'true'
              userinfo.token.claim: 'false'
      - id: 59b9e667-75be-43d4-8d7c-6189d27d67aa
        name: accounts
        description: accounts that user has access to
        protocol: openid-connect
        attributes:
          include.in.token.scope: 'true'
          display.on.consent.screen: 'false'
        protocolMappers:
          - id: 24e06173-456c-4404-9f57-529d065dafc9
            name: accounts mapper
            protocol: openid-connect
            protocolMapper: script-accounts-mapper.js
            consentRequired: false
            config:
              multivalued: 'false'
              userinfo.token.claim: 'true'
              id.token.claim: 'true'
              access.token.claim: 'true'
              claim.name: accounts
              jsonType.label: JSON
      - id: f88fa5e5-05b2-4214-94ba-89c0de3de3c1
        name: web-origins
        description: OpenID Connect scope for add allowed web origins to the access token
        protocol: openid-connect
        attributes:
          include.in.token.scope: 'false'
          display.on.consent.screen: 'false'
          consent.screen.text: ''
        protocolMappers:
          - id: 15f985fb-3949-4f58-a343-5e417934f992
            name: allowed web origins
            protocol: openid-connect
            protocolMapper: oidc-allowed-origins-mapper
            consentRequired: false
            config: {}
      - name: factory-admin
        protocol: openid-connect
        attributes:
          include.in.token.scope: "true"
        protocolMappers:
        - name: factory-admin-mapper
          protocol: openid-connect
          protocolMapper: oidc-hardcoded-role-mapper
          config:
            role: {{ .Values.keycloak.ngsildUpdates.serviceRole }}
      - name: profile
        description: 'OpenID Connect built-in scope: profile'
        protocol: openid-connect
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: ${profileScopeConsentText}
        protocolMappers:
          - id: 37de5bd3-e78f-497e-89e3-20e96e15e200
            name: birthdate
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: birthdate
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: birthdate
              jsonType.label: String
          - id: 3e6e7501-4868-4c5c-b9a2-4e5715c5da1b
            name: locale
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: locale
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: locale
              jsonType.label: String
          - id: aef2997b-7954-4758-bd51-9869e321f03a
            name: website
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: website
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: website
              jsonType.label: String
          - id: 182af694-a6d3-4117-8886-4cbe920052c5
            name: middle name
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: middleName
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: middle_name
              jsonType.label: String
          - id: f4f72077-b028-4c1a-9c5b-e2fe4a16a212
            name: nickname
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: nickname
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: nickname
              jsonType.label: String
          - id: 0809097b-c31d-4730-af8b-ac0eba043eb9
            name: zoneinfo
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: zoneinfo
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: zoneinfo
              jsonType.label: String
          - id: 42947f4a-5cdb-4ddd-a6a5-e47f6b6c0ed9
            name: updated at
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: updatedAt
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: updated_at
              jsonType.label: String
          - id: 9b30ede3-621d-460e-98d7-170c6f367dce
            name: family name
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: lastName
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: family_name
              jsonType.label: String
          - id: 1a9a0ea5-e915-4d7f-85a5-315c1c7f5e43
            name: username
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: username
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: preferred_username
              jsonType.label: String
          - id: 5e356c98-95ef-4e18-82ba-f8a248e5caf2
            name: given name
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: firstName
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: given_name
              jsonType.label: String
          - id: 249c2a24-85fb-4886-ba1d-dfd13a60b874
            name: profile
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: profile
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: profile
              jsonType.label: String
          - id: 869abe14-d993-46e1-b640-f59eec12495b
            name: gender
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: gender
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: gender
              jsonType.label: String
          - id: 30ef574e-6c0a-4ebe-971d-443b997456a3
            name: full name
            protocol: openid-connect
            protocolMapper: oidc-full-name-mapper
            consentRequired: false
            config:
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"
          - id: fc41fb8a-54ae-41ae-a37d-0fa4fe773a7f
            name: picture
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: picture
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: picture
              jsonType.label: String
      - id: 69ad66ac-8ba9-402e-8bba-8ea55a996fe3
        name: roles
        description: OpenID Connect scope for add user roles to the access token
        protocol: openid-connect
        attributes:
          include.in.token.scope: "false"
          display.on.consent.screen: "true"
          consent.screen.text: ${rolesScopeConsentText}
        protocolMappers:
          - id: f9317de0-427b-48e1-bfe2-17a9bca48883
            name: realm roles
            protocol: openid-connect
            protocolMapper: oidc-usermodel-realm-role-mapper
            consentRequired: false
            config:
              user.attribute: foo
              access.token.claim: "true"
              claim.name: realm_access.roles
              jsonType.label: String
              multivalued: "true"
          - id: 14f23054-f9a0-41d3-8b52-db912afa6a58
            name: audience resolve
            protocol: openid-connect
            protocolMapper: oidc-audience-resolve-mapper
            consentRequired: false
            config: {}
          - id: 1bec7a6b-6796-4a93-96a7-7a6f33ec6c89
            name: client roles
            protocol: openid-connect
            protocolMapper: oidc-usermodel-client-role-mapper
            consentRequired: false
            config:
              user.attribute: foo
              access.token.claim: "true"
              claim.name: resource_access.${client_id}.roles
              jsonType.label: String
              multivalued: "true"
      - id: 21090fa7-b6e1-40d2-8ed9-2811301a0bb8
        name: offline_access
        description: 'OpenID Connect built-in scope: offline_access'
        protocol: openid-connect
        attributes:
          consent.screen.text: ${offlineAccessScopeConsentText}
          display.on.consent.screen: "true"
      - id: a89645b1-4070-476e-9a6e-a4b0b294953c
        name: email
        description: 'OpenID Connect built-in scope: email'
        protocol: openid-connect
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "true"
          consent.screen.text: ${emailScopeConsentText}
        protocolMappers:
          - id: 55d2750e-7107-4d26-bf36-73517cb6fcff
            name: email verified
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: emailVerified
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: email_verified
              jsonType.label: boolean
          - id: b4a95f4c-99d5-45ea-a1bb-453d0baaf44f
            name: email
            protocol: openid-connect
            protocolMapper: oidc-usermodel-property-mapper
            consentRequired: false
            config:
              userinfo.token.claim: "true"
              user.attribute: email
              id.token.claim: "true"
              access.token.claim: "true"
              claim.name: email
              jsonType.label: String
    clients:
      - id: 31c8cc5a-9df2-4606-927a-4aeda07c1e56
        clientId: {{ .Values.keycloak.alerta.client }}
        publicClient: False
        standardFlowEnabled: True
        redirectUris: 
        {{- range .Values.keycloak.alerta.redirectUris}}
        - {{.}}
        {{- end }}
        defaultClientScopes:
        {{- range .Values.keycloak.alerta.defaultClientScopes}}
        - {{.}}
        {{- end }}
        {{ if $alertasecret }}
        secret: {{ $alertasecret.data.CLIENT_SECRET | b64dec }}
        {{ else }}
        secret: {{ .Values.alertaClientSecret }}
        {{ end }}
      - id: c77ee348-a359-4198-8c18-d0110577c00a
        clientId: {{ .Values.keycloak.scorpio.client }}
        publicClient: True
        directAccessGrantsEnabled: True
        standardFlowEnabled: True
        defaultClientScopes:
        {{- range .Values.keycloak.alerta.defaultClientScopes}}
        - {{.}}
        {{- end }}
      - id: 2057e003-9e81-44fb-929d-4511ce2c7e33
        clientId: {{ .Values.keycloak.ngsildUpdates.client }}
        publicClient: False
        serviceAccountsEnabled: True
        defaultClientScopes:
        - roles
        - factory-admin
        {{ if $ngsildupdatessecret }}
        secret: {{ $ngsildupdatessecret.data.CLIENT_SECRET | b64dec }}
        {{ else }}
        secret: {{ .Values.keycloak.ngsildUpdates.clientSecret }}
        {{ end }}
      - id: 0a5c1e78-e10d-4c1c-98bb-8f6f07860306
        clientId: {{ .Values.keycloak.oisp.frontend.client }}
        publicClient: false
        directAccessGrantsEnabled: true
        serviceAccountsEnabled: true
        authorizationServicesEnabled: true
        defaultRoles:
          - user
        defaultClientScopes:
          - oisp-frontend
          - mqtt-broker
          - roles
          - accounts
          - type
          - email
          - offline_access
          - web-origins
        optionalClientScopes:
          - gateway
        {{ if $oispfrontendsecret }}
        secret: {{ $oispfrontendsecret.data.CLIENT_SECRET | b64dec }}
        {{ else }}
        secret: {{ .Values.oispFrontendClientSecret }}
        {{ end }}
      - id: 56707dab-c91b-4c6e-99b8-718b29d7506d
        clientId: {{ .Values.keycloak.oisp.mqttBroker.client }}
        publicClient: false
        directAccessGrantsEnabled: true
        defaultClientScopes:
          - role_list
          - profile
          - roles
          - accounts
          - type
          - email
          - web-origins
          - offline_access
        {{ if $mqttbrokersecret }}
        secret: {{ $mqttbrokersecret.data.CLIENT_SECRET | b64dec }}
        {{ else }}
        secret: {{ .Values.mqttBrokerClientSecret }}
        {{ end }}
      - id: e306ad59-af6f-4047-a62b-6f014129eb02
        clientId: {{ .Values.keycloak.oisp.fusionBackend.client }}
        publicClient: false
        serviceAccountsEnabled: true
        authorizationServicesEnabled: true
        defaultClientScopes:
          - profile
          - role_list
          - roles
          - accounts
          - type
          - email
          - web-origins
        {{ if $fusionbackendsecret }}
        secret: {{ $fusionbackendsecret.data.CLIENT_SECRET | b64dec }}
        {{ else }}
        secret:  {{ .Values.fusionBackendClientSecret }}
        {{ end }}
      - id: 9bc22f4d-c6d6-4dec-9620-a02a33dc19af
        clientId: {{ .Values.keycloak.oisp.fusionFrontend.client }}
        rootUrl: https://platform.industry-fusion.com/fusionfrontend
        baseUrl: "/"
        redirectUris:
          - "/*"
        webOrigins:
          - https://platform.industry-fusion.com/fusionfrontend
        publicClient: true
        protocolMappers:
          - id: 7bc91536-6249-429a-81f9-7e84e4c0c58c
            name: IF_COMPANY
            protocol: openid-connect
            protocolMapper: oidc-usermodel-attribute-mapper
            consentRequired: false
            config:
              userinfo.token.claim: 'true'
              user.attribute: IF_COMPANY
              id.token.claim: 'true'
              access.token.claim: 'true'
              claim.name: IF_COMPANY
              jsonType.label: long
        defaultClientScopes:
          - role_list
          - profile
          - roles
          - accounts
          - type
          - email
          - web-origins
          - offline_access
        optionalClientScopes:
          - gateway
    roles:
      realm:
        - id: eda3350f-395c-449c-b985-fd8111f2dfe8
          name: uma_authorization
          description: "${role_uma_authorization}"
          clientRole: false
          containerId: oisp-frontend
        - id: 76176cd7-5bfc-4739-9883-4164ce0e8b5a
          name: offline_access
          description: "${role_offline-access}"
          clientRole: false
          containerId: oisp-frontend
      client:
        {{ .Values.keycloak.scorpio.client }}: 
          - id: 57adefda-7cd3-4519-80d2-8336b82c5488
            name: "Factory-Admin"
            clientRole: true
          - id: 5bf75888-79d1-4b25-8b88-acdbe197bf3e
            name: "Factory-Writer"
            clientRole: true
          - id: 72162ebf-2816-43a1-8df0-2d2e9380a7d6
            name: "Factory-Reader"
            clientRole: true
        {{ .Values.keycloak.oisp.frontend.client }}:
          - id: '069018ee-a092-41d0-a736-ac92b0ac6cd2'
            name: sysadmin
            clientRole: true
          - id: d36cf39e-89bf-40a6-a4e3-b7a74916b7a3
            name: uma_protection
            clientRole: true
          - id: f2dc88fe-b66a-412a-9268-824c9a601ecd
            name: system
            clientRole: true
          - id: 4dc379aa-f32c-45d0-9546-4f1d1a83acce
            name: user
            clientRole: true
        {{ .Values.keycloak.oisp.fusionBackend.client }}:
          - id: 4294f9fb-010a-4e15-bad5-acbf9d928692
            name: FLEET_MANAGER
            clientRole: true
          - id: '09d46ef8-df01-459e-ab10-76979376154e'
            name: ECOSYSTEM_MANAGER
            clientRole: true
          - id: 794fbb83-b749-4827-a4e6-b989f057b71d
            name: FACTORY_MANAGER
            clientRole: true
          - id: 617d3f63-7067-4da6-b8aa-8cfe8a9a926f
            name: uma_protection
            clientRole: true
    users:
      - id: 542f92bb-6f7c-485c-bb21-8e3da1eb1d87
        username: {{ .Values.keycloak.realmTestUser.username }}
        firstName: "John"
        lastName: "Doe"
        email: "user@example.com"
        enabled: True
        emailVerified: False
        credentials:
          - type: "password"
            {{ if $realmusersecret }}
            value: {{ $realmusersecret.data.password | b64dec }}
            {{ else }}
            value: {{ .Values.keycloak.realmTestUser.password }}
            {{ end }}
        realmRoles:
          - offline_access
        clientRoles:
          account:
            - "manage-account"
          realm-management:
            - "manage-users"
          {{ .Values.keycloak.scorpio.client }}:
            - Factory-Admin
      - id: 8a561605-7b80-44b8-aa65-4368e292a60f
        username: service-account-fusion-backend
        createdTimestamp: 1614222112374
        enabled: true
        totp: false
        emailVerified: false
        serviceAccountClientId: {{ .Values.keycloak.oisp.fusionBackend.client }}
        credentials: []
        realmRoles:
          - uma_authorization
          - offline_access
        clientRoles:
          account:
            - view-profile
            - manage-account
          {{ .Values.keycloak.oisp.fusionBackend.client }}:
            - uma_protection
          {{ .Values.keycloak.oisp.frontend.client }}:
            - user
      - id: d2a2f87d-ca88-4b17-a716-7ce07ec7f71d
        username: service-account-oisp-frontend
        createdTimestamp: 1574012647096
        enabled: true
        totp: false
        emailVerified: false
        email: service-account-oisp-frontend@placeholder.org
        serviceAccountClientId: {{ .Values.keycloak.oisp.frontend.client }}
        credentials: []
        realmRoles:
          - uma_authorization
          - offline_access
        clientRoles:
          realm-management:
            - impersonation
            - view-realm
            - view-clients
            - view-users
            - manage-users
          {{ .Values.keycloak.oisp.frontend.client }}:
            - uma_protection
          account:
            - view-profile
            - manage-account
      - id: d5c1fe02-043a-4a62-ba0f-d3260bf4d9a7
        username: service-account-realm-management
        createdTimestamp: 1576086685765
        enabled: true
        totp: false
        emailVerified: false
        email: service-account-realm-management@placeholder.org
        serviceAccountClientId: realm-management
        credentials: []
        realmRoles:
          - uma_authorization
          - offline_access
        clientRoles:
          realm-management:
            - uma_protection
          {{ .Values.keycloak.oisp.frontend.client }}:
            - user
          account:
            - view-profile
            - manage-account
    scopeMappings:
      - client: {{ .Values.keycloak.oisp.frontend.client }}
        roles:
          - uma_authorization
      - clientScope: offline_access
        roles:
          - offline_access
    clientScopeMappings:
      realm-management:
        - client: {{ .Values.keycloak.oisp.frontend.client }}
          roles:
            - view-realm
            - impersonation
            - manage-users
            - view-users
            - view-clients
